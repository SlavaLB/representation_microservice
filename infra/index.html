<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Math & PLC Interface</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  background: #f0f2f5;
  font-family: 'Segoe UI', sans-serif;
  padding: 50px 0;
}

.container {
  max-width: 900px;
}

h1 {
  text-align: center;
  margin-bottom: 40px;
  font-weight: 600;
}

.response-card {
  margin-top: 20px;
  padding: 20px;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s ease-in-out;
}

.response-card.show {
  opacity: 1;
  transform: translateY(0);
}

.response-card h5 {
  margin-bottom: 10px;
  font-weight: 500;
}

.result-value {
  font-size: 1.4rem;
  font-weight: bold;
  color: #0d6efd;
}

#sendBtn {
  width: 100%;
}

table th, table td {
  vertical-align: middle;
  font-size: .9rem;
}

.controls {
  display:flex;
  gap:10px;
  align-items:flex-end;
  margin-bottom:15px;
}

.extra-table {
  border-collapse: collapse;
  width: 100%;
  font-size: .85rem;
}
.extra-table td {
  padding: 4px 6px;
  border: 1px solid #e9ecef;
}
.extra-key {
  font-weight: 600;
  width: 35%;
  background: #fafbfc;
}
.extra-value {
  word-break: break-word;
}
.extra-badge {
  display:inline-block;
  padding: .15rem .4rem;
  font-size:.75rem;
  border-radius:.35rem;
  background:#f1f5ff;
  color:#0d6efd;
  margin-right:6px;
  margin-bottom:4px;
}
.small-muted {
  font-size:.8rem;
  color:#6c757d;
}
</style>
</head>
<body>

<div class="container">
  <h1>Math Model & PLC</h1>

  <div class="mb-3">
    <label for="numberInput" class="form-label">Введите число:</label>
    <input type="number" class="form-control" id="numberInput" placeholder="Например, 4">
  </div>
  <button id="sendBtn" class="btn btn-primary mb-3">Отправить</button>

  <div class="response-card mt-4" id="mathCard">
    <h5>Math Model:</h5>
    <div class="result-value" id="mathResult">–</div>
  </div>

  <div class="response-card mt-3" id="plcCard">
    <h5>PLC:</h5>
    <div class="result-value" id="plcResult">–</div>
  </div>
</div>

<div class="container mt-4">
  <div class="controls">
    <div style="flex:1">
      <label for="limitInput" class="form-label">Введите limit:</label>
      <input type="number" class="form-control" id="limitInput" placeholder="Например, 1000">
    </div>
    <div>
      <button id="logsBtn" class="btn btn-secondary">Логи</button>
    </div>
  </div>

  <table class="table table-sm table-striped" id="logsTable">
    <thead class="table-dark">
      <tr>
        <th>Время</th>
        <th>Название</th>
        <th>Уровень</th>
        <th>Файл</th>
        <th>Линия</th>
        <th>Сообщение</th>
        <th>Extra</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<script>
const sendBtn = document.getElementById('sendBtn');
const numberInput = document.getElementById('numberInput');
const mathCard = document.getElementById('mathCard');
const plcCard = document.getElementById('plcCard');
const mathResult = document.getElementById('mathResult');
const plcResult = document.getElementById('plcResult');

sendBtn.addEventListener('click', async () => {
  const number = numberInput.value;
  if (!number) {
    alert('Введите число!');
    return;
  }

  mathResult.textContent = "…";
  plcResult.textContent = "…";

  mathCard.classList.remove('show');
  plcCard.classList.remove('show');

  try {
    const response = await fetch('http://localhost/api/representation/get_number_in_math_model', {
      method: 'POST',
      headers: {
        'accept': 'application/json',
        'Content-Type': 'application/json',
        'number': number,
      },
    });

    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    const data = await response.json();

    mathResult.textContent = data.model_answer ?? '–';
    plcResult.textContent = data.plc_answer ?? '–';

    mathCard.classList.add('show');
    plcCard.classList.add('show');

  } catch (err) {
    console.error(err);
    mathResult.textContent = "Ошибка!";
    plcResult.textContent = "Ошибка!";
    mathCard.classList.add('show');
    plcCard.classList.add('show');
  }
});

const logsBtn = document.getElementById('logsBtn');

function removeMillis(ts) {
  if (!ts) return ts;
  return String(ts).replace(/[.,]\d{1,3}$/, '');
}

function createTextCell(text) {
  const td = document.createElement('td');
  td.textContent = text ?? '-';
  return td;
}

function renderExtra(extra) {
  const td = document.createElement('td');

  if (extra === null || extra === undefined) {
    td.textContent = '-';
    return td;
  }

  let parsed = extra;
  if (typeof extra === 'string') {
    try {
      parsed = JSON.parse(extra);
    } catch (e) {
      td.textContent = extra;
      td.title = extra;
      return td;
    }
  }

  if (typeof parsed !== 'object' || Array.isArray(parsed)) {
    td.textContent = Array.isArray(parsed) ? JSON.stringify(parsed) : String(parsed);
    td.title = JSON.stringify(parsed, null, 2);
    return td;
  }

  const table = document.createElement('table');
  table.className = 'extra-table';
  const tbody = document.createElement('tbody');

  Object.keys(parsed).forEach(key => {
    const val = parsed[key];
    const tr = document.createElement('tr');

    const tdKey = document.createElement('td');
    tdKey.className = 'extra-key';
    tdKey.textContent = key;
    tr.appendChild(tdKey);

    const tdVal = document.createElement('td');
    tdVal.className = 'extra-value';

    if ((/date|time|created|at|timestamp/i).test(key) && (typeof val === 'string')) {
      tdVal.textContent = removeMillis(val);
      tdVal.title = val;
    } else if (typeof val === 'object' && val !== null) {
      tdVal.textContent = JSON.stringify(val);
      tdVal.title = JSON.stringify(val, null, 2);
    } else {
      tdVal.textContent = String(val);
    }

    tr.appendChild(tdVal);
    tbody.appendChild(tr);
  });

  table.appendChild(tbody);
  td.appendChild(table);

  td.title = JSON.stringify(parsed, null, 2);
  return td;
}

logsBtn?.addEventListener('click', async () => {
  const limitInput = document.getElementById('limitInput');
  const limit = Number(limitInput?.value) || 10;

  const url = `http://localhost/api/logs/logs?limit=${encodeURIComponent(limit)}`;

  try {
    const response = await fetch(url, { method: 'GET', headers: { 'accept': 'application/json' } });
    if (!response.ok) throw new Error('Network response was not ok');
    const logs = await response.json();

    const tbody = document.querySelector('#logsTable tbody');
    tbody.innerHTML = '';

    const info = logs?.info;

    if(!Array.isArray(info)) return;
    info.forEach(log => {
      const tr = document.createElement('tr');

      const ts = removeMillis(log.timestamp);
      tr.appendChild(createTextCell(ts));

      tr.appendChild(createTextCell(log.name));
      tr.appendChild(createTextCell(log.level));
      tr.appendChild(createTextCell(log.file));
      tr.appendChild(createTextCell(log.line));
      tr.appendChild(createTextCell(log.message));

      tr.appendChild(renderExtra(log.extra));

      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error('Ошибка при получении логов:', err);
    alert('Не удалось получить логи (смотрите консоль).');
  }
});
</script>

</body>
</html>
